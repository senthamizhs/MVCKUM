@using System.Configuration;
@{
    string StrVersion = ConfigurationManager.AppSettings["UpdateVersion"] != null ? ConfigurationManager.AppSettings["UpdateVersion"].ToString() : "";
    string allowcredit = (Session["ALLOW_CREDIT"] != null && Session["ALLOW_CREDIT"].ToString() != "") ? Session["ALLOW_CREDIT"].ToString() : "N";
    string allowtopup = (Session["ALLOW_TOPUP"] != null && Session["ALLOW_TOPUP"].ToString() != "") ? Session["ALLOW_TOPUP"].ToString() : "N";
    string Allowcurrency = (Session["Allowappcurrency"] != null && Session["Allowappcurrency"].ToString() != "") ? Session["Allowappcurrency"].ToString() : ConfigurationManager.AppSettings["currency"].ToString();
    string strTerminalType = ConfigurationManager.AppSettings["TerminalType"].ToString();
    string DateValidation = ConfigurationManager.AppSettings["Reportdatecheck"].ToString();
    string strPNRLable = ConfigurationManager.AppSettings["PNRlbl"].ToString();
    string Terminalpriviledge = (Session["privilage"] != null && Session["privilage"].ToString() != "") ? Session["privilage"].ToString() : "T"; /* S-> for Superviser T-> for Travel Consultant */
    string TerminalCount = (Session["AgentTerminalCount"] != null && Session["AgentTerminalCount"].ToString() != "") ? Session["AgentTerminalCount"].ToString() : "1";
    string TerminalId = Session["POS_TID"].ToString();
    string agnid = Session["POS_ID"].ToString();
    string StrTKTFLAG = Session["TKTFLAG"] != null && Session["TKTFLAG"].ToString() != "" ? Session["TKTFLAG"].ToString() : "DTKT";
    string strProduct = ConfigurationManager.AppSettings["Producttype"].ToString();
    string strImageURL = ConfigurationManager.AppSettings["LogoUrl"].ToString();
    string strLoaderURL = strImageURL + "/" + strProduct + "/" + "loader.gif?" + StrVersion;
}
<link href="~/Content/CSS/Controlpanel.css?@StrVersion" rel="stylesheet" />
<link href="~/js/jqxtable/jqx.base.css" rel="stylesheet" />
<link href="~/js/jqxtable/jqx.energyblue.css" rel="stylesheet" />
<script src="~/js/jqxtable/jqx-all.js"></script>
<script src="~/js/jqxtable/jqxchart.core.js"></script>
<script src="~/js/jqxtable/jqxcore.js"></script>
<script src="~/js/jqxtable/modernizr.js"></script>
<link href="~/Content/CSS/CommonCSS/W2Grid.css" rel="stylesheet" />
<script src="~/js/W2Grid.js"></script>
<script src="~/js/moment.min.js"></script>
<link href="~/Content/CSS/Search/jquerycalender-new.css" rel="stylesheet" />
<style>
@@media screen and (max-width: 720px) and (min-width: 350px) {#margintop {margin-top: 10px;}}
.table-striped > tbody > tr:nth-of-type(odd) {background-color: #ccc !important;}
.table > tbody > tr > td {border-bottom: 1px solid #fff !important;}
@@media screen and (max-width: 991px) and (min-width: 769px) {.console.container {width:95%;}
.clsspntitle {position: inherit;top:-3px;}}

</style>
<div id="dvsamplemain" class="rightside">
    <!--marquee-->
    <div class="console container pad-0">
        <div class="row row0">
            <div class="M_be007">
                <div class="col-xs-12 col-md-12 col-sm-12 bg-white mg-btm-20 mg-tp-20 R_box-shadow col0 mg-tp-0-res">
                    <div class="cls-header m-b-10" id="Heading">
                        <h4 class="Rpt_headertilte bg-lt-blu">
                            <span class="R_transt_sprit sprit_p1"></span><span>Agent Transaction Details</span></h4>
                    </div>
                    <div class="col-xs-12 col-md-12 col-sm-12 col-lg-12 martpplus10 pad-0">
                        <div class="col-xs-12 col-md-2 col-sm-3 col-lg-2 change_new_old_confirm_pass">
                            <div class="dv-anim input-effect m-0 m-sm-t15">
                                <input id="txtSPNR" maxlength="11" onkeypress="return ValigridcelldateSpecialChar(event);" class="txt-anim" type="text" />
                                <label>@strPNRLable</label>
                                <span class="focus-border">
                                    <i></i>
                                </span>
                            </div>
                        </div>
                        @if (strTerminalType == "T")
                        {
                            <div class="col-xs-12 col-md-4 col-sm-4 col-lg-4 change_new_old_confirm_pass" id="agentdeti">
                                <span class="clsspntitle">Agency Name</span>
                                <input type="text" id="ddlclient_agent" class="txt-anim" />
                            </div>
                        }
                        <div class="col-xs-6 col-md-2 col-sm-3 col-lg-2 change_new_old_confirm_pass">
                            <div class="dv-anim input-effect m-0 m-sm-t15">
                                <span id="lblFromDate" class="clsspntitle">Transaction Type</span>
                                <input readonly="readonly" id="txt_AirBook_fromdate" class="txt-anim" type="text" />
                                <span class="focus-border">
                                    <i></i>
                                </span>
                            </div>
                        </div>
                        <div class="col-xs-6 col-md-2 col-sm-3 col-lg-2 change_new_old_confirm_pass">
                            <div class="dv-anim input-effect m-0 m-sm-t15">
                                <span id="lblToDate" class="clsspntitle">From Date</span>
                                <input readonly="readonly" id="txt_AirToodate" class="txt-anim" type="text" />
                                <span class="focus-border">
                                    <i></i>
                                </span>
                            </div>
                        </div>
                        <div class="col-xs-12 col-md-2 col-sm-3 col-lg-2 change_new_old_confirm_pass">
                            <span id="Transaction_Type" class="clsspntitle">Transaction Type</span>
                            <select class="clscmbanim" id="op_searchBy">
                                <option value="ALL">ALL</option>
                                <option value="C">Credit</option>
                                <option value="D">Debit</option>
                            </select>
                        </div>

                        <div class="col-xs-12 col-md-2 col-sm-3 col-lg-2 change_new_old_confirm_pass">
                            <span id="Product&nbsp;Type" class="clsspntitle">Product Type</span>
                            <select class="clscmbanim" id="op_product">
                            </select>
                        </div>
                        <div class="col-xs-12 col-md-2 col-sm-3 col-lg-2 change_new_old_confirm_pass" id="displaypayment">
                            <span id="Payment_mode" class="clsspntitle">Payment Mode</span>
                            <select class="clscmbanim" id="op_Paymentmode">
                                <option value="">All</option>
                                @if (strTerminalType != "T")
                                {
                                    if (allowtopup == "Y")
                                    {
                                        <option value="T">Topup</option>
                                    }
                                    if (allowcredit == "Y")
                                    {
                                        <option value="C">Credit</option>
                                    }
                                }
                                else
                                {
                                    <option value="C">Credit</option>
                                    <option value="T">Topup</option>
                                }
                            </select>
                        </div>

                        @if (Terminalpriviledge == "S" && TerminalCount != "" && TerminalCount != "1")
                        {
                            <div class="col-xs-12 col-md-2 col-sm-3 col-lg-2 change_new_old_confirm_pass">
                                <span id="Terminal_id" class="clsspntitle">Terminal Id</span>
                                <select class="clscmbanim" id="agn_terminal"></select>
                            </div>
                        }
                        else
                        {
                            <div class="col-xs-12 col-md-2 col-sm-3 col-lg-2 change_new_old_confirm_pass">
                                <select id="agn_terminal" style="display: none">
                                    <option value="@TerminalId" selected="selected"></option>
                                </select>
                            </div>
                        }

                        <div class="col-xs-12 col-md-12 col-sm-12 col-lg-12 col0" style="margin-bottom: 15px; margin-top: 10px;">
                            @if (Allowcurrency.IndexOf('|') > 0)
                            {
                                <div class="col-xs-12 col-md-2 col-sm-3 col-lg-2 change_new_old_confirm_pass">
                                    <span id="spn_currency" class="clsspntitle">Currency Code</span>
                                    <select class="clscmbanim" id="op_currencycode">
                                        <option value="">Select</option>
                                        @for (int i = 0; i < Allowcurrency.Split('|').Length; i++)
                                        {
                                            <option value='@Allowcurrency.Split('|')[i]'>@Allowcurrency.Split('|')[i]</option>
                                    }
                                    </select>
                                </div>
                        }
                            else
                            {
                                <select style="display: none;" id="op_currencycode">
                                    <option value='@Allowcurrency' selected="selected">@Allowcurrency</option>
                                </select>
                        }
                            <div class="col-xs-6 col-md-2 col-sm-3 col-lg-2 col-lg-offset-3 col-md-offset-3 col-sm-offset-2 ">
                                <input type="button" class="action-button shadow animate color" id="btn_ok" style="width: 100%;" value="Get" onclick="return getdetails();" />
                            </div>
                            <div class="col-xs-6 col-md-2 col-sm-3 col-lg-2">
                                <input type="button" id="btn_clear" class="action-button action-buttonB shadow animate  colorB1" style="width: 100%;" value="Clear" onclick="return Btn_clr_Click();" />
                            </div>
                            <div class="hidden-xs col-md-2 col-sm-3 col-lg-2" id="margintop">
                                @using (Html.BeginForm("ExportData_agenttopup", "CntrlPanel", FormMethod.Post, new { enctype = "multipart/form-data" }))
                                {  
                                    <input type="submit" id="Btn_excel" class="action-button shadow animate color colorG" style="width: 100%; display: none;" value="Export to Excel" />              
                            }
                            </div>
                        </div>
                        <div class="col-xs-12 col-md-12 col-sm-12 col-lg-12 ">
                            <div id="Div_Char" class="col-xs-12 col-md-12 col-sm-12 col-lg-12 " style="padding: 0px; height: auto; overflow: auto;"></div>
                            <div id="charterror" class="col-xs-12 col-md-12 col-sm-12 col-lg-12" style="text-align: center;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="~/js/commontable_boostrap.js?@StrVersion"></script>
<script src="~/js/cbpFWTabs.js?@StrVersion"></script>
<script src="~/js/Slider/jquery.easing.1.3.js?@StrVersion"></script>
<script src="~/js/jquery.nice-select.js?@StrVersion"></script>
<script src="~/js/CommonJS/jquery-ui-new.js"></script>
<script>

    var Terminaltype = '@strTerminalType';
    var allowcredit = '@allowcredit';
    var allowtopup = '@allowtopup';
    var T_priviledge = '@Terminalpriviledge';
    var T_Count = '@TerminalCount';
    var AgentId = '@agnid';
    var currentDate = "@ViewBag.ServerDateTime";
    var datevalidation = '@DateValidation';
    var product_length = "@ViewBag.hdn_product_list_for_sales";
    var flag = '@StrTKTFLAG';

    var loaderimgurl = '@strLoaderURL';
    var topup_transactionurl = "@Url.Action("RequestTopupFunction", "CntrlPanel")";
    var qtkt_transactionurl = "@Url.Action("RequestTopupFunction", "RetriveBooking")";
    var sessionexpurl = "@Url.Action("SessionExp", "Redirect")";
    var exporttoexcelurl = "@Url.Action("btnExportExcell", "CntrlPanel")";
    var clientdetailsurl = "@Url.Action("GetClientData", "Home")";

    $(document).ready(function () {
        var day = currentDate.split('/');
        var select12 = $('#op_product');// document.getElementById('fareClass' + Id);//
        var mm = product_length.split('~');
        var day = day[0]
        var day2 = day[0]
        var month = day[1]
        var year = day[2]

        if (mm.length > 0) {
            select12.empty();
            for (var j = 0; j < mm.length; j++) {
                if (mm[j] != "") {//|| mm[j] != null) {
                    var Im = mm[j].toString();//.split('/')
                    var opt = document.createElement('option');
                    opt.value = Im.split('|')[0];
                    opt.text = Im.split('|')[1];
                    select12.append(opt);
                }
            }
        }

        $("#txt_AirBook_fromdate").val(currentDate);
        $("#txt_AirBook_fromdate").addClass("has-content");
        $("#txt_AirBook_fromdate").datepicker({
            maxDate: currentDate, dateFormat: "dd/mm/yy", changeMonth: true, changeYear: true,
        });
        $("#txt_AirToodate").val(currentDate);
        $("#txt_AirToodate").addClass("has-content");
        $("#txt_AirToodate").datepicker({
            minDate: $("#txt_AirBook_fromdate").val(), maxDate: currentDate, dateFormat: "dd/mm/yy", changeMonth: true, changeYear: true,
        });
        $("#txt_AirBook_fromdate").on('change keyup paste', function () {
            $("#txt_AirToodate").datepicker("destroy");
            $("#txt_AirToodate").datepicker({
                minDate: $("#txt_AirBook_fromdate").val(), maxDate: currentDate, dateFormat: "dd/mm/yy", changeMonth: true, changeYear: true,
            });
        });
        $("#displayfarecal").css("display", "none");
        if (Terminaltype == "T") {
            LoadClient();
        }
        if (allowtopup == 'Y' && allowcredit == 'Y') {
            $("#displaypayment").css("display", "block");
        }
        if (T_priviledge == "S" && parseInt(T_Count) > 1) {
            $('#agn_terminal').empty();
            $("#agn_terminal").append('<option value="">ALL</option>');
            for (var m = 1; m <= parseInt(T_Count) ; m++) {
                if (m < 10) {
                    $("#agn_terminal").append('<option value="' + AgentId + "0" + m + '">' + AgentId + "0" + m + '</option>');
                }
                else {
                    $("#agn_terminal").append('<option value="' + AgentId + m + '">' + AgentId + m + '</option>');
                }
            }
        }
        $('.clscmbanim').niceSelect();
    });

    function getdetails() {
        var AgentId = "";
        if (Terminaltype == "T") {
            //AgentId = $("#ddlclient_agent").val();
            if ($("#ddlclient_agent").val() == "") {
                alert("Please select Agency Name");
                return false;
            }
            AgentId = ClientID;
        }
        else {
            AgentId = "";
        }
        var TerminalDetails = $("#agn_terminal").val();
        //if ($("#op_Paymentmode").val() == null || $("#op_Paymentmode").val() == "") {
        //    alert("Please select payment mode");
        //    return false;
        //}
        if ($("#op_currencycode").val() == null || $("#op_currencycode").val() == "") {
            alert("Please select currency code");
            return false;
        }
        if ($("#txt_AirBook_fromdate").val() == "") {
            alert("Please select from date");
            return false;
        }
        if ($("#txt_AirToodate").val() == "") {
            alert("Please select to date");
            return false;
        }
        if (datevalidation == "Y") {
            var fromdate = $("#txt_AirBook_fromdate").val();
            var todate = $("#txt_AirToodate").val();
            var today = moment().format('DD/MM/YYYY');
            if (fromdate != todate && todate == today) {
                alert("Please avoid current date and previous date combination...");
                return false;
            }
        }

        $.blockUI({
            message: '<img alt="Please Wait..." src="' + loaderimgurl + '" style="background-color:#fff; border-radius:8px; margin-top:12%;" id="FareRuleLodingImage" />',
            css: { padding: '5px' }
        });

        var URl = (flag == "DTKT") ? topup_transactionurl : qtkt_transactionurl;
        $.ajax({
            type: "POST", 		//GET or POST or PUT or DELETE verb
            url: URl,
            data: '{fromdate:"' + $("#txt_AirBook_fromdate").val() + '" ,todate: "' + $("#txt_AirToodate").val() + '",sPNR: "' + $("#txtSPNR").val() + '",option:  "' + $("#op_searchBy").val() + '",product:  "' + $("#op_product").val() + '",AccountType:  "' + $("#op_Paymentmode").val() + '",AgentId:"' + AgentId + '",Currencycode:"' + $("#op_currencycode").val() + '",Terminal_ID:"' + TerminalDetails + '"}',
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function (json) {//On Successful service call
                var result = json.Result;
                if (result[1] != null && result[1] != "") {
                    document.getElementById('Btn_excel').style.display = "block";
                }
                var appendiv = document.getElementById('Div_Char').id;
                CreateJQgrid(result);
                $.unblockUI();
            },
            error: function (e) {//On Successful service call
                $.unblockUI();
                if (e.status == "500") {
                    alert("Session has been Expired.");
                    window.location.href = sessionexpurl
                    return false;
                }
            }	// When Service call fails

        });
    }

    function Btn_clr_Click() {
        document.getElementById("Btn_excel").style.display = "none";
        document.getElementById("Div_Char").style.display = "none";
        $("#txtSPNR").val("");
        $("#txtSPNR").removeClass("has-content");
        $("#op_product").val("All");
        $('#op_product').niceSelect('destroy').niceSelect();
        $("#AgentName").val("");
        $("#txt_AirBook_fromdate").val(currentDate);
        $("#txt_AirBook_fromdate").addClass("has-content");
        $("#txt_AirBook_fromdate").datepicker({
            maxDate: currentDate, dateFormat: "dd/mm/yy", changeMonth: true, changeYear: true,
        });
        $("#txt_AirToodate").val(currentDate);
        $("#txt_AirToodate").addClass("has-content");
        $("#txt_AirToodate").datepicker({
            minDate: $("#txt_AirBook_fromdate").val(), maxDate: currentDate, dateFormat: "dd/mm/yy", changeMonth: true, changeYear: true,
        });
    }

    function ExporttoExcel() {
        var Heading = document.getElementById("Heading").innerHTML;
        $.ajax({
            type: "POST", 		//GET or POST or PUT or DELETE verb
            url: exporttoexcelurl,
            data: '{cal_fromdate:"' + $("#txt_AirBook_fromdate").val() + '" ,cal_todate: "' + $("#txt_AirToodate").val() + '",Heading: "' + Heading + '"}',
            contentType: "application/json; charset=utf-8",
            dataType: "html",
            success: function (json) {//On Successful service call
                var result = json.Result;
            },
            error: function (e) {//On Successful service call
                $.unblockUI();
                if (e.status == "500") {
                    alert("Session has been Expired.");
                    window.location.href = sessionexpurl
                    return false;
                }
            }
        });
    }

    function CreateJQgrid(result) {
        if (result[0] != "") {
            document.getElementById("charterror").style.display = "Block";
            document.getElementById("Div_Char").style.display = "none";
            document.getElementById("charterror").innerHTML = result[0];
            document.getElementById("charterror").style.color = "RED";
            document.getElementById("charterror").style.fontWeight = "bold";
            document.getElementById("charterror").style.textAlign = "center";
            document.getElementById("Btn_excel").style.display = "none";
        }
        if (result[1] != "") {
            document.getElementById("Div_Char").style.display = "Block";
            document.getElementById("charterror").style.display = "none";
            document.getElementById("Btn_excel").style.display = "block";
            var json = result[1];
            var obj = $.parseJSON(json);
            var datafields = new Array();
            var columns = new Array();
            for (var i = 0; i < obj.length; i++) {
                var object1 = {
                    recid: i,
                };
                $.extend(obj[i], object1);
            }
            for (var i in obj[0]) {
                if (i != "recid") {
                    if (i == "Transaction Date") {
                        columns.push({ field: i, caption: i, resizable: true, sortable: true, attr: 'align=left', size: '150px' });
                    }
                    else if (i == "Remarks" || i == "Description") {
                        columns.push({ field: i, caption: i, resizable: true, sortable: true, attr: 'align=left', size: '250px' });
                    }
                    else if (i == "Transaction Type") {
                        columns.push({ field: i, caption: i, resizable: true, sortable: true, attr: 'align=left', size: '350px' });
                    }
                    else if (i == "Credit" || i == "Debit" || i == "Balance" || i == "Outstanding") {
                        columns.push({ field: i, caption: i, resizable: true, sortable: true, attr: 'align=right', size: '120px' });
                    }
                    else if (i == "Transaction Amount") {
                        columns.push({ field: i, caption: i, resizable: true, sortable: true, attr: 'align=right', size: '150px' });
                    }
                    else if (i == "S PNR" || i == "CRS PNR") {
                        columns.push({ field: i, caption: i, resizable: true, sortable: true, attr: 'align=left', size: '100px' });
                    }
                    else {
                        columns.push({ field: i, caption: i, resizable: true, sortable: true, attr: 'align=left', size: '130px' });
                    }
                }
            }

            $("#Div_Char").w2destroy('AgentTansaction');
            $("#Div_Char").w2grid(
            {
                name: 'AgentTansaction',
                //recid: "ROW_NUMBER",
                recordHeight: 30,
                show: { footer: true, toolbar: true },
                columns: columns,
                records: obj,

            });
            $("#Div_Char").css("min-height", "450px");
        }
    }

    function LoadClient() {
        $.ajax({
            type: "POST",
            url: clientdetailsurl,
            contentType: "application/json; charset=utf-8",
            timeout: 180000,
            dataType: "json",
            success: function (data) {
                var data = data["Data"];
                try {
                    var arr = JSON.parse(data.Result);
                    if (data.Status == "01") {
                        $('#ddlclient_agent').typeahead('destroy');
                        $('#ddlclient_agent').typeahead({
                            source: arr,
                            items: 5,
                            displayField: "CLTNAME",
                            valueField: "CLTCODE",
                            scrollBar: true,
                            onSelect: displayResults,
                        });
                        function displayResults(item) {
                            ClientID = item.value;
                        }
                    }
                    else {
                        $('#ddlclient_agent').hide();
                        $('#agentdeti').hide();
                    }
                }
                catch (err) {
                    console.log(err.message)
                }
            },
            error: function (e) {
            }
        });
    }
</script>