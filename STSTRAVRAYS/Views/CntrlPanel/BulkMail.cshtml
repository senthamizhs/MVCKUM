<html>
<head>
    <title>BulkMail</title>
</head>
<body>
    <link href="~/Content/CSS/jquery.dropdown.css" rel="stylesheet" />
    <script src="~/js/BulkMail/FileUpload.js"></script>
    <link href="~/Content/CSS/FileUpload.css" rel="stylesheet" />
    <input type="hidden" id="hdfLoginId" />
    <input type="hidden" id="hdfcostcenterlevel" />
    <input type="hidden" id="hdflevelscount" />
    <script src="~/js/jquery.blockUI.js"></script>
    <link href="~/Content/CSS/bootstrap-multiselect.css" rel="stylesheet" />
    <script src="~/js/BulkMail/bootstrap-multiselect.js"></script>
    <style>
        #textareamail1 {
            height: 300px;
        }

        .fileuploader-input-caption {
            font-size: 10px;
        }

        .note-group-select-from-files {
            display: none;
        }

        .bulkmaildiv .note-codable {
            display: none;
        }

        #dvEmpDetailsGrid {
            max-height: 300px;
            overflow: auto;
        }

        .achorsubtbtn {
            width: 20%;
            float: right;
            align-items: center;
            display: inline-flex;
            justify-content: center;
            outline: none;
            z-index: 0;
            letter-spacing: .25px;
            background: none;
            color: #5f6368;
            cursor: pointer;
            font-weight: 500;
            height: 36px;
            min-width: 80px;
            outline: none;
            padding: 0 16px;
            color: #fff;
            border: none;
            border: 2px solid #2c9ee9;
            background: #2c9ee9;
            border-radius: 4px;
        }

            .achorsubtbtn:hover {
                background: #fff;
                color: #2c9ee9;
            }

        .bulkmaildiv .txtmailcmp:focus, .bulkmaildiv .txtmailcmp:focus,
        .bulkmaildiv .txtmailcmp, .bulkmaildiv .txtmailcmp {
            padding-bottom: 8px;
            padding-top: 8px;
            border: none !important;
            -webkit-box-shadow: inset 0 -1px 0 0 rgba(100,121,143,0.122);
            box-shadow: inset 0 -1px 0 0 rgba(100,121,143,0.122);
            line-height: 20px;
            min-height: auto;
            padding-left: 0;
            padding-right: 0;
            margin: 0;
            position: relative;
            -webkit-transition: box-shadow .15s cubic-bezier(0.4,0.0,0.2,1);
            transition: box-shadow .15s cubic-bezier(0.4,0.0,0.2,1);
            z-index: 1;
        }

        .fileuploader-theme-dragdrop .fileuploader-input {
            padding: 70px 0 30px 0 !important;
        }

        .dropdown-selected {
            color: #333 !important;
        }

        #selectbox label {
            white-space: nowrap;
        }

        .MisMainDivSelect:disabled .dropdown-display {
            background-color: #f5f5f5 !important;
            cursor: no-drop;
        }

        .Dropdownbox {
            height: 30px !important;
        }

        .MisMainDivSelect:disabled .dropdown-display {
            background-color: #f5f5f5 !important;
            cursor: no-drop;
        }

        .chosen-container-multi .chosen-choices li.search-field input[type="text"] {
            margin: 1px 0;
            padding: 5px;
            height: 30px !important;
            outline: 0;
            border: 0 !important;
            background: transparent !important;
            box-shadow: none;
            color: #666;
            font-size: 100%;
            line-height: normal;
            border-radius: 0;
        }

        .Dropdownbox:disabled {
            cursor: no-drop;
            background: #f5f5f5;
        }

        #txtmailContent {
            border: none;
            padding-top: 10px;
        }

        .comclsloaddiv {
            margin-top: 20px;
        }

        .mailupld .fileuploader {
            margin: 0px;
            border: none;
            padding-bottom: 0;
        }

        .box-shadow {
            -webkit-box-shadow: 0 2px 5px 0 rgba(0,0,0,.16), 0 2px 10px 0 rgba(0,0,0,.12);
            box-shadow: 0 2px 5px 0 rgba(0,0,0,.16), 0 2px 10px 0 rgba(0,0,0,.12);
        }

        .mailupld .fileuploader-theme-dragdrop .fileuploader-input img {
            position: absolute;
            left: 40%;
        }

        .MisMainDivSelect {
            height: 41px;
            width: 272px;
        }

        .open > .dropdown-menu {
            width: 100%;
            max-height: 250px;
            overflow: auto;
            padding: 5px 8px;
        }

        .multiselect-container > li > a > label {
            color: #524f4f;
            padding: 0px 20px 0px 15px;
            font-size: 12px;
            font-weight: 600;
            white-space: normal;
        }

        .dropdown-menu > li > a {
            line-height: 18px;
        }

            .dropdown-menu > li > a:active {
                color: #333;
            }

        .combobox {
        }

        .input-style input {
            width: auto;
            height: initial;
        }

        .btn, .btn.disabled, .btn[disabled] {
            border-color: black;
        }

        .input-group-addon {
            color: #fff;
            background-color: #fff;
        }

        #grpdrop .btn-group {
            width: 100% !important;
        }
    </style>


    <div class="container _Mth4 _Mth3 _Mth2 _Mth1">
        <div class="row row0">
            <div class="col-md-12 col-xs-12 bulkmaildiv">
                <div class="cls-header m-b-10" style="display: none;">
                    <h4 class="Rpt_headertilte">
                        <span class="R_bulkmail_sprit sprit_p1"></span><span>Bulk Mail</span>
                    </h4>
                </div>
                <div class="row requestpage branchnam">
                    <div class="col-sm-5 col-md-4 col-lg-3 col-xs-12 mrg-btm-20">
                        <div class="tabs-block">
                            <h5><span>Branch</span></h5>
                            <div class="input-style" id="grpdrop">
                                <select name="dropdown" class="form-control clsborder txtboxcom combobox" id="ddlBranch" onchange="loadagent(this.id)">
                                    <option selected="selected" value="">ALL</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-5 col-md-4 col-lg-3 col-xs-12 mrg-btm-20" id="mail">
                        <div class="tabs-block">
                            <h5><span>Agency Name</span></h5>
                            <div class="input-style" id="ddloadcorp">
                                <select name="dropdown" class="form-control clsborder txtboxcom combobox" multiple="multiple" id="ddlAgentType">
                                    <option selected="selected" value="">ALL</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="dvEmpDetailsGrid" class="columns col-lg-12 col-xs-12 requestpage"></div>

                <div class="row requestpage mailsec">
                    <div class="col-md-8 col-xs-12 empcls comclsloaddiv">
                        <div class='col-lg-12 col-xs-12 dragfilewholediv pad-0'>
                            <div class="panel panel-default box-shadow">
                                <div class="panel-body">
                                    <form autocomplete="off">
                                        <input type="text" class="txtmailcmp" placeholder="Cc" id="txtccbcc" />
                                        <input type="text" class="txtmailcmp" placeholder="Subject" id="txtSubject" />
                                    </form>
                                    <div id="txtmailContent"></div>
                                    <a class="c-button b-50 bg-aqua hv-transparent cmn-bg-clr btn-round achorsubtbtn" id="Submit" style="" onclick="Submitbtn()"><span>Submit</span></a>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 col-xs-12 empcls comclsloaddiv">
                        <div class='col-xs-12 dragfilewholediv pad-0'>
                            <div class='tabs-block'>
                                <div class='input-style box-shadow mailupld'>
                                    <input type='file' id='flilUpload' multiple name='files' class='form-control' />"
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="~/js/Column_Table/jquery.columns.js"></script>
    <script src="~/js/Column_Table/mustache.min.js"></script>
    <script src="~/js/BulkMail/table-renderer.js"></script>
    <script src="~/js/BulkMail/TElibrary.js"></script>
    <script src="~/js/BulkMail/textedit.js"></script>

    <script type="text/javascript">
        $('#txtmailContent').summernote({
            height: 350,   //set editable area's height
            codemirror: { // codemirror options
                theme: 'monokai'
            }
        });
        var companyides = "";

        var Fullary = [];
        var CommonAry = [];
        var selectcorp = [];
        var loadbrnchdet = []

        LoadARLCorpName()
        function LoadARLCorpName() {
            var bkcostid = 1;
            var Param = {
                Loginsession: document.getElementById('hdfLoginId').value,
                useridflag: bkcostid,
                companyides: companyides,
            }


            $.ajax({
                type: "POST",
                contentType: "application/json; charset=utf-8",
                url: '@Url.Action("CompanyName", "CntrlPanel")',
                data: JSON.stringify(Param),
                timeout: 100000,
                dataType: "json",
                success: function (data) {
                    $.unblockUI();
                    if (data.Errormsg != "") {
                        alert("Unable to fetch data (#05).");
                        return false;
                    }
                    if (data.arrfetchdata != "") {
                        var ArrRes = data.arrfetchdata;

                        CommonAry = data.arrfetchdata;

                        if (ArrRes[1] != "" && ArrRes[1] != null) {
                            loadbranchtext()
                            loadcorporate()
                        }
                    }
                },

                error: function (result) {
                    $.unblockUI();
                    alert("Unable to connect to remote server! Please try again later!");
                }
            });
        }

        function loadbranchtext() {

            var ddltext = "";
            var ddlvalue = "";
            ddltext = JSON.parse(CommonAry[4]);

            selectcorp = ddltext;
            var ddlOnwardSement3 = document.getElementById("ddlBranch");
            var ddloptions = "";
            var childOptionCSelect = new Option();

            ddlOnwardSement3[0] = childOptionCSelect;
            var optioncount = 1;

            var build = "";
            build += "<option value='ALL'> ALL </option>";
            ddltext = ddltext.reduce(function (item, e1) {
                var matches = item.filter(function (e2)
                { return e1.CLT_BRANCH_ID == e2.CLT_BRANCH_ID });
                if (matches.length == 0) {
                    item.push(e1);
                }
                return item;
            }, []);
            $.each(ddltext, function (s, k) {
                build += "<option value=" + ddltext[s].CLT_BRANCH_ID + ">" + ddltext[s].BRH_BRANCH_NAME + "</option>"
            })

            $("#ddlBranch").html(build);
            $('#ddlBranch').multiselect({

                includeSelectAllOption: false,
                selectAllNumber: false,
                enableFiltering: true,
                enableCaseInsensitiveFiltering: true,
            });
            $.unblockUI();
        }

        function loadcorporate() {

            var ddltext = "";
            var ddlvalue = "";
            ddltext = JSON.parse(CommonAry[4]);

            selectcorp = ddltext;
            var ddlOnwardSement3 = document.getElementById("ddlAgentType");
            var ddloptions = "";
            var childOptionCSelect = new Option();

            ddlOnwardSement3[0] = childOptionCSelect;
            var optioncount = 1;

            var build = "";
            // build += "<option value='ALL'> ALL </option>";
            $.each(ddltext, function (s, k) {

                build += "<option value=" + ddltext[s].CLT_CLIENT_ID + ">" + ddltext[s].CLT_CLIENT_NAME + "</option>"

            });
            text = ddltext.length;
            $("#ddlAgentType").html(build);


            $('#ddlAgentType').multiselect({

                includeSelectAllOption: false,
                selectAllNumber: false,
                enableFiltering: true,
                enableCaseInsensitiveFiltering: true,
            });

            $.unblockUI();

        }

        var strbuild = "";
        function fetchagentmail(terminal) {
            strbuild = "";
            var agenttype = terminal;
            BranchId = $("#ddlBranch").val();
            var oFile = document.getElementById("flilUpload").files[0]; // <input type="file" id="fileUpload" accept=".jpg,.png,.gif,.jpeg"/>
            if (oFile != null && oFile != "" && oFile != undefined) {
                if (oFile.size > 1000000) // 2 mb for bytes.
                {
                    alert("File size must less than 1 mb");
                    return false;
                }
            }

            if ($("#txtSubject").val().trim() == "") {
                alert("Please enter subject ");

                return false;
            }
            var selectedagent = terminal == "" ? "ALL" : terminal;
            var selectedbranch = $("#ddlBranch").val();
            $.ajax({
                type: "POST",
                contentType: "application/json; charset=utf-8",
                url: '@Url.Action("Fetchagentmailid", "CntrlPanel")',
                data: "{'Agents':'" + selectedagent + "',Branch:'" + selectedbranch + "'}",
                dataType: "json",
                success: function (data) {
                    $.unblockUI();
                    if (data.Errormsg != "") {
                        return false;
                    }
                    else if (data.status == "0") {
                        alert("Problem occured while fetching mail details");
                        return false;
                    }
                    else {
                        $(".comclsloaddiv").show()
                    }
                    if (data.status == "01" && data.message != "ALL") {
                        var data = JSON.parse(data.message);
                        var len = data["Table"].length;
                        if (len > 0) {
                            for (i = 0; i < len; i++) {
                                if (data["Table"][i].CLT_EMAIL_ID != null && data["Table"][i].CLT_EMAIL_ID != "") {
                                    strbuild += data["Table"][i].CLT_EMAIL_ID + ",";
                                }
                            }
                        } else {
                            strbuild = "ALL";
                        }

                    }
                    else if (data.status == "01" && data.message == "ALL") {
                        strbuild = "ALL";
                    }

                    if (strbuild == "") {
                        alert("Selected agent mail id's are empty");
                        return false;
                    }

                    var FilePath = "";

                    var BranchId = "";
                    var Companyid = [];

                    BranchId = $("#ddlBranch").val() == null || $("#ddlBranch").val() == "" ? "ALL" : $("#ddlBranch").val();
                    $("#ddlAgentType").val() == null ? Companyid.push("ALL") : Companyid = $("#ddlAgentType").val();


                    EmployeeMailid = strbuild;
                    var data = new FormData();
                    var files = $("#flilUpload").get(0).files;
                    data.append("ImgCount", files.length);
                    if (files.length > 0) {
                        for (var N = 0; files.length > N; N++) {
                            if (files.length > 0) {
                                data.append("MyData" + N, N);
                                data.append("MyImages" + N, files[N]);
                            }
                        }
                        $.ajax({
                            url: "@Url.Action("UploadFile", "CntrlPanel")",
                            type: "POST",
                            processData: false,
                            contentType: false,
                            data: data,
                            async: false,
                            success: function (response) {
                                if (response == "00") {
                                    alert("Problem Occured While Upload File.");
                                    return false;
                                }
                                else if (response == "0") {
                                    alert("File Length Exceeded");
                                }
                                else {
                                    FilePath = response;
                                }
                            }
                        });
                    }

                    var BulkMailInfo = {
                        strCompanyId: Companyid,
                        strEmpMailId: EmployeeMailid,
                        strCCMailId: $("#txtccbcc").val(),
                        strBmlCcMailId: "",
                        strSubject: $("#txtSubject").val(),
                        strMailContent: $("#textareamail1").html(),
                        strAttachment: FilePath,
                        strBranchId: BranchId
                    }
                    $.ajax({
                        type: "POST",
                        url: '@Url.Action("InsertBulkMail", "CntrlPanel")',
                        data: JSON.stringify(BulkMailInfo),
                        timeout: 300000,
                        contentType: "application/json; charset=utf-8",
                        dataType: "json",
                        success: function (json) {
                            if (json.status == "-1") {
                                window.location.href = "@Url.Action("SessionExp", "Redirect")";
                            }

                            if (json.status == "00") {
                                alert(json.result);
                                return false;
                            }
                            else if (json.status == "01") {
                                alert("Your mail request successfully processing will receieve email shortly");
                                return false;
                            }
                            else {
                                alert(json.Errormsg);
                                return false;
                            }
                        },

                    });
                },
                error: function (result) {
                    alert("Unable to connect to remote server! Please try again later!");
                }
            });

        }

        function Submitbtn() {
            var totalAgentType = $('#ddlAgentType').val() != null ? $('#ddlAgentType').val().join(',') : "";
            fetchagentmail(totalAgentType);

            $('#flilUpload').getEvali({
                limit: 50,
                fileMaxSize: 20,
                changeInput: '<div class="fileuploader-input">' + '<div class="fileuploader-input-inner">' + '<img src="../Images/fileuploader-dragdrop-icon.png">' + '<h3 style="font-size:12px;" class="fileuploader-input-caption"><span>Drag and drop files here</span></h3>' + '<p>or</p>' + '<div class="fileuploader-input-button"><span>Browse Files</span></div>' + '</div>' + '</div>',
                theme: 'dragdrop',
                addMore: true,
                thumbnails: {
                    removeConfirmation: true,
                    _selectors: {
                        sorter: '.fileuploader-item'
                    }
                },

                skipFileNameCheck: true,
                editor: {
                    cropper: {
                        showGrid: true
                    }
                },
                sorter: {
                    selectorExclude: '.fileuploader-action-popup, .fileuploader-action-remove'
                },
                captions: {
                    feedback: 'Drag and drop files here',
                    feedback2: 'Drag and drop files here',
                    drop: 'Drag and drop files here'
                }
            });
            $('#ddlBranch').change(function () {
                $("#ddlAgentType").val("");
                $(".fileuploader-action-remove").click();
                $("#txtccbcc").val("");
                $("#txtSubject").val("");
                $("#textareamail1").val("");
            });
        }
        function loadagent(arg) {
            $(".comclsload").html("");
            var Group = CommonAry;
            var groupval = $("#" + arg).val();
            selectcorp = [];

            if (Group[4] != null && Group[4] != "") {
                var selectcorp = [];
                var Groupname = JSON.parse(Group[4]);
                if (groupval === null || groupval == "ALL") {
                    selectcorp = Groupname
                }
                else {
                    selectcorp = $.grep(Groupname, function (n, l) {
                        return groupval.indexOf(n.CLT_BRANCH_ID) != -1
                    });
                }

                var ddltext = selectcorp;
                $("#ddlAgentType").html("");
                var ddlOnwardSement3 = document.getElementById("ddlAgentType");
                var ddloptions = "";
                var childOptionCSelect = new Option();

                ddlOnwardSement3[0] = childOptionCSelect;
                var optioncount = 1;

                var gptxt = "";
                //if (ddltext.length > 1)
                //    gptxt += "<option class='allagent' onclick='clickallagent()' value='ALL'>ALL</option>";

                $.each(ddltext, function (u, k) {
                    gptxt += "<option class='allagentlst' value=" + ddltext[u].CLT_CLIENT_ID + ">" + ddltext[u].CLT_CLIENT_NAME + "</option>"
                });
                $('#ddlAgentType').empty();
                $('#ddlAgentType').multiselect('destroy');

                $("#ddlAgentType").html(gptxt)
                $('#ddlAgentType').multiselect({

                    includeSelectAllOption: false,
                    selectAllNumber: false,
                    enableFiltering: true,
                    enableCaseInsensitiveFiltering: true,
                });
            }
        }

    </script>
</body>
</html>

